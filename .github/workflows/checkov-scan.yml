name: Checkov Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  checkov:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Checkov
        run: pip install checkov

      - name: Create reports directory
        run: mkdir -p checkov_reports

      - name: Run Checkov scan (Alternative method)
        run: |
          echo "Trying alternative Checkov command..."
          checkov -d . --output json --soft-fail > checkov_reports/checkov_output.json 2>&1 || true
          
          # Check if the output file exists and has content
          if [ -f "checkov_reports/checkov_output.json" ] && [ -s "checkov_reports/checkov_output.json" ]; then
            mv checkov_reports/checkov_output.json checkov_reports/report.json
            echo "✅ Checkov report created successfully"
          else
            echo "❌ Checkov output file is empty or missing"
            # Create a minimal report for testing
            echo '{"results": {"passed_checks": [], "failed_checks": []}}' > checkov_reports/report.json
          fi

      - name: Debug Checkov Output
        run: |
          echo "=== Checkov Report Debug ==="
          ls -la checkov_reports/
          echo "=== Report content ==="
          if [ -f "checkov_reports/report.json" ]; then
            echo "File exists, size: $(wc -c < checkov_reports/report.json) bytes"
            echo "First 50 lines:"
            head -50 checkov_reports/report.json
          elif [ -d "checkov_reports/report.json" ]; then
            echo "ERROR: report.json is a directory!"
            ls -la checkov_reports/report.json/
          else
            echo "Report file not found!"
          fi

      - name: Generate Markdown Report
        run: python scripts/generate_md_report.py

      - name: Upload Checkov Report
        uses: actions/upload-artifact@v4
        with:
          name: checkov-security-report
          path: checkov_reports/

      - name: Display Report Summary
        run: |
          echo "## 🛡️ Checkov Security Scan Results"
          if [ -f "checkov_reports/report.md" ]; then
            head -20 checkov_reports/report.md
          fi